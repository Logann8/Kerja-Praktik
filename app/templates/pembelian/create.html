{% extends "base.html" %}

{% block title %}Tambah Pembelian - Aplikasi Pembelian{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-cart-plus"></i> Transaksi Pembelian Baru</h2>
            <a href="{{ url_for('pembelian.index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Kembali
            </a>
        </div>

        <form method="POST" action="{{ url_for('pembelian.create') }}" id="formPembelian">
            {{ form.hidden_tag() }}
            
            <!-- Header Pembelian -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Data Pembelian</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.no_faktur.label(class="form-label") }}
                            {{ form.no_faktur(class="form-control" + (" is-invalid" if form.no_faktur.errors else "")) }}
                            {% if form.no_faktur.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.no_faktur.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.tanggal.label(class="form-label") }}
                            {{ form.tanggal(class="form-control" + (" is-invalid" if form.tanggal.errors else "")) }}
                            {% if form.tanggal.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.tanggal.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.vendor_id.label(class="form-label") }}
                            {{ form.vendor_id(class="form-select" + (" is-invalid" if form.vendor_id.errors else "")) }}
                            {% if form.vendor_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.vendor_id.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.keterangan.label(class="form-label") }}
                        {{ form.keterangan(class="form-control" + (" is-invalid" if form.keterangan.errors else "")) }}
                        {% if form.keterangan.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.keterangan.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Detail Pembelian -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Detail Barang</h5>
                    <button type="button" class="btn btn-light btn-sm" id="btnTambahBaris">
                        <i class="bi bi-plus-circle"></i> Tambah Barang
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="tabelDetail">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 5%;">No</th>
                                    <th style="width: 30%;">Barang</th>
                                    <th style="width: 15%;">Qty</th>
                                    <th style="width: 15%;">Satuan</th>
                                    <th style="width: 20%;">Harga</th>
                                    <th style="width: 15%;">Subtotal</th>
                                    <th style="width: 5%;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyDetail">
                                <!-- Baris detail akan ditambahkan secara dinamis -->
                            </tbody>
                            <tfoot>
                                <tr class="table-info">
                                    <td colspan="5" class="text-end fw-bold">TOTAL:</td>
                                    <td class="fw-bold" id="totalPembelian">Rp 0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{{ url_for('pembelian.index') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Batal
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Simpan Pembelian
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let rowCounter = 0;
let barangData = {};

// Load data barang saat halaman dimuat
fetch('{{ url_for("barang.index") }}')
    .then(response => response.text())
    .then(html => {
        // Parse HTML untuk mendapatkan data barang (simplified)
        // Dalam implementasi nyata, lebih baik menggunakan API endpoint
    });

// Fungsi untuk mendapatkan data barang via API
async function getBarangData(barangId) {
    if (barangData[barangId]) {
        return barangData[barangId];
    }
    try {
        const response = await fetch(`{{ url_for('pembelian.get_barang', barang_id=0) }}`.replace('0', barangId));
        const data = await response.json();
        barangData[barangId] = data;
        return data;
    } catch (error) {
        console.error('Error fetching barang:', error);
        return null;
    }
}

// Fungsi untuk menambah baris detail
function tambahBaris() {
    rowCounter++;
    const tbody = document.getElementById('tbodyDetail');
    const row = document.createElement('tr');
    row.id = `row-${rowCounter}`;
    
    row.innerHTML = `
        <td>${rowCounter}</td>
        <td>
            <select name="detail_barang_id[]" class="form-select form-select-sm barang-select" required>
                <option value="">-- Pilih Barang --</option>
                {% for barang in barangs %}
                <option value="{{ barang.id }}" data-satuan="{{ barang.satuan }}" data-harga="{{ float(barang.harga_beli) }}">
                    {{ barang.kode }} - {{ barang.nama }}
                </option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="detail_qty[]" class="form-control form-control-sm qty-input" 
                   step="0.01" min="0.01" required placeholder="0.00">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm satuan-display" readonly>
        </td>
        <td>
            <div class="input-group input-group-sm">
                <span class="input-group-text">Rp</span>
                <input type="number" name="detail_harga[]" class="form-control form-control-sm harga-input" 
                       step="0.01" min="0" required placeholder="0.00">
            </div>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm subtotal-display" readonly value="Rp 0.00">
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm btn-hapus" onclick="hapusBaris(${rowCounter})">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    
    // Attach event listeners
    const barangSelect = row.querySelector('.barang-select');
    const qtyInput = row.querySelector('.qty-input');
    const hargaInput = row.querySelector('.harga-input');
    
    barangSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const satuan = selectedOption.getAttribute('data-satuan') || '';
        const harga = selectedOption.getAttribute('data-harga') || '0';
        
        row.querySelector('.satuan-display').value = satuan;
        hargaInput.value = parseFloat(harga).toFixed(2);
        hitungSubtotal(row);
    });
    
    qtyInput.addEventListener('input', () => hitungSubtotal(row));
    hargaInput.addEventListener('input', () => hitungSubtotal(row));
}

// Fungsi untuk menghapus baris
function hapusBaris(rowId) {
    const row = document.getElementById(`row-${rowId}`);
    if (row) {
        row.remove();
        updateNomorBaris();
        hitungTotal();
    }
}

// Fungsi untuk menghitung subtotal per baris
function hitungSubtotal(row) {
    const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
    const harga = parseFloat(row.querySelector('.harga-input').value) || 0;
    const subtotal = qty * harga;
    
    row.querySelector('.subtotal-display').value = 'Rp ' + subtotal.toLocaleString('id-ID', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    hitungTotal();
}

// Fungsi untuk menghitung total
function hitungTotal() {
    let total = 0;
    document.querySelectorAll('.subtotal-display').forEach(display => {
        const value = display.value.replace('Rp ', '').replace(/\./g, '').replace(',', '.');
        total += parseFloat(value) || 0;
    });
    
    document.getElementById('totalPembelian').textContent = 'Rp ' + total.toLocaleString('id-ID', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Fungsi untuk update nomor baris
function updateNomorBaris() {
    let counter = 1;
    document.querySelectorAll('#tbodyDetail tr').forEach(row => {
        row.querySelector('td:first-child').textContent = counter;
        counter++;
    });
}

// Event listener untuk tombol tambah baris
document.getElementById('btnTambahBaris').addEventListener('click', tambahBaris);

// Tambahkan baris pertama saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
    tambahBaris();
});
</script>
{% endblock %}

